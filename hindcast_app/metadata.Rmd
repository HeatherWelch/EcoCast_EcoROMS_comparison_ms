---
title: "EcoCast 2.0 hindcast exploration"
author: "Heather Welch"
date:  "`r format(Sys.Date())`"
output: 
  html_document:
    keep_md: true
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(raster)
library(sp)
library(tidyverse)
library(rworldmap)
library(rgdal)
library(rasterVis)
library(RColorBrewer)
library(ggmap)
library(grid)
library(lattice)
library(gridExtra)
library(maptools)
library(dplyr)
library(reshape)
library(pracma)
library(magick)
library(png)
library(maps)
library(purrr)

## follows hindcast_extract_plot_random.R

```
# Introduction
This is a hindcast test of the EcoVerse - a suite of algorithms to reduce bycatch while maximizing target catch in near real-time. 
The hindcast was run between **1997-10-01 and 1997-11-31** (lots of swordfish catches), **2003-04-01 and 2003-04-30** (lots of lbst tracking points), **2005-08-01 and 2005-11-31** (lots of tracking points for all species), and **all dates with leatherback bycatch events**. 

However, instead of using real data a random point hindcast was conducted, consisting of 1700 random points between across the same date ranges as the real data. At each random point, all algorithm values were compared to all species habitat suitabilities. Random data was used instead of real data to remove the effect of model fit on hindcast results. As opposed to evaluating the ability of the algorithm to avoid/target true presences (which can have low predicted suitability), we are evaluating the ability of the algorithm to avoid/target predicted suitability values.

The random data is a uniform grid:

```{r,echo=FALSE,message=F, warning=F,out.width='50%'}
master=read.csv("/Volumes/SeaGate/EcoCast_EcoROMS_comparison_ms/EcoCast_EcoROMS_comparison_ms/raw_data/species_predict_04.24.18_random_run5.csv")
clean=master[complete.cases(master),]
map.US <- map_data(map="state")
a=ggplot()+geom_point(data = clean,aes(lon,lat),color="blue",size=.7,alpha=.4)+geom_map(data=map.US,map=map.US,aes(map_id=region,x=long,y=lat),fill="grey")+coord_cartesian()
a=a+coord_cartesian(xlim=c(-133,-115),ylim=c(29,49),expand=F)+ggtitle("Random data")
a

```


**How the Marxan algorithm works**  <br>
Marxan attempts to solve a min set cover problem, i.e. what is the minimum set of planning units (here 10x10 pixels) needed to meet **targets** for **conservation features** while minimizing **costs**. <br>
-targets: the species weightings <br>
-conservation features: the bycatch species and the inverse of swordfish  <br>
-costs: total area (the impact of cost here is minimized as far as possible: we're not trying to design compact protected areas)  <br>

How Marxan is run in EcoMarxan <br>
Species habitat suitability layers (HSL) are input into Marxan with the three bycatch species and inverted swordfish as conservation features. The species weightings used to set targets for the conservation features (e.g. blsh = .4 ---> protect 40% of blsh habitat). Because we are trying to avoid swordfish habitat, swordfish is inverted (subtracted from 1), such that where swor equaled .1, it now equales .9. Marxan will try to maximize protecting "highly suitable" swordfish habitat, which is in actually areas that are most unsuitable pre inversion.

For a given day, Marxan is run 1000 times to create an output of selection frequency, i.e. the number of times / 1000 each pixel was selected for a solution.

Two algorithms were tested:  <br>
**1. EcoROMS original** - species habitat suitability layers (HSL) are weighted, summed, and then normalized between -1 and 1  <br>
**2. Marxan raw** - the raw selection frequency output (0-1000) rescaled to (-1,1)  <br>

Three "runs" with differing species weightings were evaluated.

# Run 1 - "extreme LBST, neutral SWOR" (all other species neutral)
Weightings in this run were select to emphasize avoiding leatherbacks as much as possible, keeping all other species weightings neutral.<br>
EcoROMS weightings: -0.1,-0.1,-0.05,-2.5,.1 ; <br>
and Marxan weightings: -0.1,-0.1,-0.05,-0.4,0.1 <br>
namesrisk<-c("Blue shark bycatch","Blue sharks","Sea lions","Leatherbacks","Swordfish")

**Example alorithm solutions
From 1995-09-11** <br>
```{r, echo=FALSE, out.width='50%'}
#### also set up generic stuff for run
# formally run 4, species_predict_04.13.18_random_run4.csv
namesrisk<-c("Blue shark bycatch","Blue sharks","Sea lions","Leatherbacks","Swordfish")
ER_weightings<-c(-0.1,-0.1,-0.05,-2.5,.1)
M_weightings<-c(-0.1,-0.1,-0.05,-0.4,0.1)

E_orig=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/EcoROMSruns/output/hindcast/mean/EcoROMS_original_",paste0(ER_weightings,collapse="_"),"_1995-09-11_mean.png")
M_raw=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/EcoROMSruns/output/hindcast/marxan/marxan_",paste0(M_weightings,collapse="_"),"_1995-09-11_raw.png")

image_list=list(E_orig,M_raw) %>% unlist
knitr::include_graphics(image_list)

```


```{r , echo=FALSE, out.width='20%'}
## print raw species files
swor=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/swor/swor_1995-09-11_mean.png")
lbst=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/lbst_nolat/lbst_nolat_1995-09-11_mean.png")
casl=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/casl_nolat/casl_nolat_1995-09-11_mean.png")
blshobs=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/blshobs/blshobs_1995-09-11_mean.png")
blshtrk=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/blshtrk_nolat/blshtrk_nolat_1995-09-11_mean.png")

image_list2=list(swor,lbst,casl,blshobs,blshtrk) %>% unlist
knitr::include_graphics(image_list2)


```


# Run 2 - "extreme LBST, moderate SWOR" (all other species neutral)
Weightings in this run were select to emphasize avoiding leatherbacks as much as possible, with moderate swordfishing weightings, keeping all other species weightings neutral.<br>
EcoROMS weightings: -0.1,-0.1,-0.05,-2.5,1.5 ;<br>
and Marxan weightings: -0.1,-0.1,-0.05,-0.4,0.2 <br>
namesrisk<-c("Blue shark bycatch","Blue sharks","Sea lions","Leatherbacks","Swordfish")

**Example alorithm solutions
From 1995-09-11** <br>
```{r, echo=FALSE, out.width='50%'}
#### also set up generic stuff for run
# formally run 5, species_predict_04.24.18_random_run5.csv
namesrisk<-c("Blue shark bycatch","Blue sharks","Sea lions","Leatherbacks","Swordfish")
ER_weightings<-c(-0.1,-0.1,-0.05,-2.5,1.5)
M_weightings<-c(-0.1,-0.1,-0.05,-0.4,0.2)

E_orig=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/EcoROMSruns/output/hindcast/mean/EcoROMS_original_",paste0(ER_weightings,collapse="_"),"_1995-09-11_mean.png")
M_raw=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/EcoROMSruns/output/hindcast/marxan/marxan_",paste0(M_weightings,collapse="_"),"_1995-09-11_raw.png")

image_list=list(E_orig,M_raw) %>% unlist
knitr::include_graphics(image_list)

```


```{r , echo=FALSE, out.width='20%'}
## print raw species files
swor=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/swor/swor_1995-09-11_mean.png")
lbst=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/lbst_nolat/lbst_nolat_1995-09-11_mean.png")
casl=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/casl_nolat/casl_nolat_1995-09-11_mean.png")
blshobs=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/blshobs/blshobs_1995-09-11_mean.png")
blshtrk=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/blshtrk_nolat/blshtrk_nolat_1995-09-11_mean.png")

image_list2=list(swor,lbst,casl,blshobs,blshtrk) %>% unlist
knitr::include_graphics(image_list2)


```


# Run 3 - "extreme LBST, extreme SWOR" (all other species neutral)
Weightings in this run were select to emphasize avoiding leatherbacks and swordfish as much as possible, keeping all other species weightings neutral.<br>
EcoROMS weightings: -0.1,-0.1,-0.05,-2.5,2.5 ; <br>
and Marxan weightings: -0.1,-0.1,-0.05,-0.4,0.4 <br>
namesrisk<-c("Blue shark bycatch","Blue sharks","Sea lions","Leatherbacks","Swordfish")

**Example alorithm solutions
From 1995-09-11** <br>
```{r, echo=FALSE, out.width='50%'}
#### also set up generic stuff for run
# formally run 6, species_predict_04.25.18_random_run6.csv
namesrisk<-c("Blue shark bycatch","Blue sharks","Sea lions","Leatherbacks","Swordfish")
ER_weightings<-c(-0.1,-0.1,-0.05,-2.5,2.5)
M_weightings<-c(-0.1,-0.1,-0.05,-0.4,0.4)

E_orig=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/EcoROMSruns/output/hindcast/mean/EcoROMS_original_",paste0(ER_weightings,collapse="_"),"_1995-09-11_mean.png")
M_raw=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/EcoROMSruns/output/hindcast/marxan/marxan_",paste0(M_weightings,collapse="_"),"_1995-09-11_raw.png")

image_list=list(E_orig,M_raw) %>% unlist
knitr::include_graphics(image_list)

```


```{r , echo=FALSE, out.width='20%'}
## print raw species files
swor=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/swor/swor_1995-09-11_mean.png")
lbst=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/lbst_nolat/lbst_nolat_1995-09-11_mean.png")
casl=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/casl_nolat/casl_nolat_1995-09-11_mean.png")
blshobs=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/blshobs/blshobs_1995-09-11_mean.png")
blshtrk=paste0("/Users/heatherwelch/Dropbox/Eco-ROMS/Model Prediction Plots/daily_predictions/blshtrk_nolat/blshtrk_nolat_1995-09-11_mean.png")

image_list2=list(swor,lbst,casl,blshobs,blshtrk) %>% unlist
knitr::include_graphics(image_list2)


```

